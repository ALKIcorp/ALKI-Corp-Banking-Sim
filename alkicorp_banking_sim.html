<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking Sim</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --font-primary: 'Press Start 2P', cursive;
            --color-background: #1a1a1a; /* Dark background */
            --color-screen-bg: #2a2a2e; /* Slightly lighter screen bg */
            --color-panel-bg: #3c3c42;  /* Panel background */
            --color-panel-border: #6b7280; /* Panel border */
            --color-text-light: #f0f0f0; /* Light text */
            --color-text-dark: #222;    /* Dark text for contrast on light elements */
            --color-text-medium: #a0a0a0; /* Medium gray text */
            --color-accent-blue: #4fc3f7; /* Bright blue accent */
            --color-accent-blue-dark: #039be5;
            --color-accent-red: #f44336; /* Red accent */
            --color-accent-green: #4caf50; /* Green accent */
            --color-border-dark: #000;
            --color-border-light: #555;
            --button-bg: #4a4a50;
            --button-hover-bg: #6a6a70;
            --button-active-bg: #3a3a40;
            --button-text: var(--color-text-light);
            --input-bg: #e0e0e0;
            --input-border: #777;
            --input-text: var(--color-text-dark);
        }

        body {
            background-color: var(--color-background);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: var(--font-primary);
            color: var(--color-text-light);
            font-size: 10px; /* Smaller base font size for retro feel */
            line-height: 1.6;
        }

        /* --- Aspect Ratio Container (4:3) --- */
        .aspect-ratio-container {
            position: relative;
            width: 95vmin; /* Use viewport width */
            max-width: 800px; /* Max width */
            min-width: 320px; /* Min width */
            background-color: #000; /* Black outer frame */
            border: 10px solid #333; /* Dark gray border */
             box-shadow:
                inset 0 0 0 3px #555, /* Inner bevel */
                0 0 20px 10px rgba(0,0,0,0.6); /* Outer shadow */
            overflow: hidden;
            border-radius: 8px; /* Slightly rounded outer corners */
        }

        .aspect-ratio-container::before {
            content: "";
            display: block;
            padding-top: 75%; /* 3 / 4 = 0.75 -> 75% for 4:3 ratio */
        }

        /* --- Game Screen --- */
        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            padding: 10px; /* Padding inside the screen */
            background-color: var(--color-screen-bg);
            overflow-y: auto; /* Allow scrolling if content overflows */
            border: 5px solid var(--color-border-light);
            border-top-color: var(--color-border-dark);
            border-left-color: var(--color-border-dark);
            border-radius: 3px; /* Inner screen slight rounding */
        }
        /* Custom scrollbar for game screen */
        .game-screen::-webkit-scrollbar { width: 8px; }
        .game-screen::-webkit-scrollbar-track { background: #333; border-radius: 4px;}
        .game-screen::-webkit-scrollbar-thumb { background: var(--color-accent-blue); border-radius: 4px; border: 1px solid #222;}
        .game-screen::-webkit-scrollbar-thumb:hover { background: var(--color-accent-blue-dark); }


        /* --- Pok√©mon B/W Inspired UI Elements --- */
        .bw-button {
            font-family: var(--font-primary);
            background: linear-gradient(to bottom, #6a6a70, #4a4a50); /* Gradient background */
            color: var(--button-text);
            border: 2px solid var(--color-border-dark); /* Outer dark border */
            border-top-color: var(--color-border-light); /* Lighter top/left for bevel */
            border-left-color: var(--color-border-light);
            padding: 6px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-flex; /* Use flex for icon alignment */
            align-items: center;
            gap: 5px; /* Space between icon and text */
            font-size: 10px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.3); /* Inner bottom shadow */
            transition: all 0.1s ease;
            white-space: nowrap;
            position: relative; /* For potential pseudo-elements */
            text-shadow: 1px 1px 0px rgba(0,0,0,0.5); /* Text shadow */
        }
        .bw-button::before { /* Optional subtle top highlight */
            content: '';
            position: absolute;
            top: 1px; left: 1px; right: 1px;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px 3px 0 0;
        }

        .bw-button:hover {
            background: linear-gradient(to bottom, var(--color-accent-blue), var(--color-accent-blue-dark)); /* Blue gradient on hover */
            border-color: var(--color-accent-blue-dark);
            border-top-color: var(--color-accent-blue);
             border-left-color: var(--color-accent-blue);
            color: #fff; /* Brighter text on hover */
            transform: translateY(-1px); /* Slight lift */
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.4), 0 2px 5px rgba(79, 195, 247, 0.3); /* Add blue glow */
        }
        .bw-button:active {
            background: linear-gradient(to top, #6a6a70, #4a4a50); /* Reverse gradient when pressed */
            transform: translateY(1px); /* Press down effect */
            box-shadow: inset 0 2px 0 rgba(0,0,0,0.3); /* Inner top shadow */
        }
        .bw-button:disabled {
            background: #555;
            border-color: #444;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.3);
        }
        .bw-button:disabled:hover {
             background: #555;
             border-color: #444;
             box-shadow: inset 0 -2px 0 rgba(0,0,0,0.3);
        }

        /* Button Icon Style */
        .btn-icon {
            font-size: 0.8em; /* Make icon slightly smaller */
            display: inline-block;
        }


        .bw-panel {
            background-color: var(--color-panel-bg);
            border: 3px solid var(--color-panel-border);
            border-top-color: #888; /* Lighter top/left border */
            border-left-color: #888;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.3); /* Inner shadow */
        }

        .bw-header {
            font-size: 14px;
            color: var(--color-text-light);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--color-panel-border);
            text-align: center;
            text-transform: uppercase; /* Uppercase headers */
            letter-spacing: 1px;
             display: flex; /* For icon alignment */
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
         .header-icon {
            font-size: 0.9em;
            color: var(--color-accent-blue); /* Icon color */
         }

        .bw-input {
            font-family: var(--font-primary);
            padding: 6px 8px;
            border: 2px solid var(--input-border);
             border-top-color: #555; /* Inner bevel */
            border-left-color: #555;
            border-radius: 4px;
            background-color: var(--input-bg);
            font-size: 10px;
            width: 100%;
            margin-bottom: 8px;
            color: var(--input-text);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
         .bw-input:focus {
            outline: none;
            border-color: var(--color-accent-blue);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2), 0 0 5px var(--color-accent-blue);
         }

        .bw-label {
            display: block;
            margin-bottom: 4px;
            font-size: 9px;
            color: var(--color-text-medium);
            text-transform: uppercase;
        }

        /* --- HUD --- */
        .hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            background: linear-gradient(to bottom, #555, #333); /* Dark gradient */
            color: var(--color-text-light);
            border-bottom: 3px solid var(--color-border-dark);
            font-size: 9px;
            position: sticky;
            top: -10px; /* Adjust slightly to account for padding */
            margin: -10px -10px 10px -10px; /* Overlap padding */
            z-index: 10;
            border-radius: 3px 3px 0 0; /* Match inner screen top radius */
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }
        .hud span {
            margin: 0 5px;
        }
        .save-indicator {
            font-size: 8px;
            opacity: 0;
            transition: opacity 0.5s ease;
            color: var(--color-accent-green); /* Green for saving */
        }
        .save-indicator.visible {
            opacity: 1;
        }
         #quit-button { /* Style quit button specifically if needed */
            font-size: 8px;
            padding: 2px 5px;
            background: linear-gradient(to bottom, #8c4f4f, #b71c1c); /* Red gradient */
             border-color: #880e0e;
             border-top-color: #e57373;
             border-left-color: #e57373;
         }
         #quit-button:hover {
            background: linear-gradient(to bottom, #e57373, #d32f2f);
            border-color: #d32f2f;
            border-top-color: #ef9a9a;
             border-left-color: #ef9a9a;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.4), 0 2px 5px rgba(244, 67, 54, 0.3); /* Red glow */
         }


        /* --- Screen Visibility Control --- */
        .screen { display: none; }
        .screen.active { display: flex; flex-direction: column; flex-grow: 1; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Specific Screen Styles --- */
        #home-screen .save-slots {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #home-screen .slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: rgba(0,0,0,0.2); /* Darker slots */
            border: 2px solid var(--color-panel-border);
            border-radius: 4px;
             transition: background-color 0.2s;
        }
         #home-screen .slot:hover {
             background-color: rgba(0,0,0,0.3);
         }
        #home-screen .slot-info {
            font-size: 10px;
            color: var(--color-text-light);
        }
        #home-screen .slot-actions button {
            margin-left: 5px;
            font-size: 9px;
            padding: 4px 8px;
        }

        /* Chart container & Tooltip Fix */
        .chart-container {
            position: relative;
            height: 160px; /* Slightly taller */
            width: 100%;
            margin-bottom: 5px; /* Reduced margin */
            padding: 5px; /* Add padding INSIDE container */
            box-sizing: border-box; /* Include padding in dimensions */
        }
        .chart-title {
             text-align: center;
             font-size: 9px;
             margin-top: 0px; /* Reduced top margin */
             margin-bottom: 10px; /* Space below title */
             color: var(--color-text-medium);
        }

        /* Bank View Layout Fix */
        #bank-view-screen .bw-panel > .grid { /* Target grid directly */
             margin-top: 15px; /* Add space above charts */
        }
        #bank-view-screen .bw-panel > h3 { /* Target headers directly */
            margin-top: 15px; /* Add space above headers */
        }

        /* Client Transaction Log */
        .transaction-log {
            margin-top: 15px;
            border-top: 2px solid var(--color-panel-border);
            padding-top: 10px;
        }
        .transaction-log h4 {
            font-size: 10px;
            margin-bottom: 5px;
            color: var(--color-text-medium);
            text-transform: uppercase;
        }
        .log-area {
            height: 80px; /* Fixed height */
            overflow-y: auto;
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--color-panel-border);
            border-radius: 3px;
            padding: 5px;
            font-size: 9px;
        }
        .log-entry {
            margin-bottom: 3px;
            padding-bottom: 3px;
            border-bottom: 1px dashed rgba(107, 114, 128, 0.5); /* Dashed separator */
        }
        .log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .log-entry .log-type-deposit { color: var(--color-accent-green); }
        .log-entry .log-type-withdrawal { color: var(--color-accent-red); }


        /* Grid layout helper */
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .gap-4 { gap: 1rem; } /* approx 16px */
        .gap-2 { gap: 0.5rem; } /* approx 8px */
        .mb-4 { margin-bottom: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-1 { margin-top: 0.25rem; }
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .w-full { width: 100%; }
        .max-w-xs { max-width: 24rem; } /* Adjust if needed */
        .max-h-32 { max-height: 8rem; } /* approx 128px */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-grow { flex-grow: 1; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; } /* approx 12px */
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; } /* approx 14px */
        .font-semibold { font-weight: 600; } /* Note: Press Start 2P only has one weight */
        .text-red-600 { color: var(--color-accent-red); }
        .text-gray-500 { color: var(--color-text-medium); }
        .text-gray-600 { color: #9ca3af; } /* Slightly different medium gray */
        .text-center { text-align: center; }
        .rounded { border-radius: 0.25rem; } /* 4px */
        .bg-gray-100 { background-color: rgba(255, 255, 255, 0.05); } /* Very subtle light background */
        .border { border-width: 1px; border-style: solid; }
        .hover\:bg-gray-200:hover { background-color: rgba(255, 255, 255, 0.1); }
        .cursor-pointer { cursor: pointer; }
        .overflow-y-auto { overflow-y: auto; }
        .border-t { border-top-width: 1px; }
        .pt-2 { padding-top: 0.5rem; }

    </style>
</head>
<body>
    <div class="aspect-ratio-container">
        <div class="game-screen">

            <div class="hud" id="game-hud" style="display: none;"> <div>
                    <span>Mode: <span id="hud-mode">---</span></span> |
                    <span>Date: <span id="hud-date">---</span></span>
                </div>
                <div>
                    <span id="save-indicator" class="save-indicator">Saving...</span>
                    <button id="quit-button" class="bw-button">
                        <span class="btn-icon">‚úñ</span> Quit
                    </button>
                </div>
            </div>

            <div id="home-screen" class="screen active">
                <div class="bw-panel flex-grow flex flex-col justify-center items-center">
                    <h1 class="bw-header mb-4">
                        <span class="header-icon">üè¶</span> Banking Sim <span class="header-icon">üè¶</span>
                    </h1>
                    <div class="save-slots w-full max-w-xs">
                        <div class="slot">
                            <span class="slot-info" id="slot-1-info">Slot 1: Empty</span>
                            <div class="slot-actions">
                                <button class="bw-button" onclick="startGame(1)"><span class="btn-icon">‚ñ∂</span> New</button>
                                <button class="bw-button" onclick="loadGame(1)" id="load-btn-1" disabled><span class="btn-icon">üìÇ</span> Load</button>
                            </div>
                        </div>
                        <div class="slot">
                            <span class="slot-info" id="slot-2-info">Slot 2: Empty</span>
                            <div class="slot-actions">
                                <button class="bw-button" onclick="startGame(2)"><span class="btn-icon">‚ñ∂</span> New</button>
                                <button class="bw-button" onclick="loadGame(2)" id="load-btn-2" disabled><span class="btn-icon">üìÇ</span> Load</button>
                            </div>
                        </div>
                        <div class="slot">
                            <span class="slot-info" id="slot-3-info">Slot 3: Empty</span>
                            <div class="slot-actions">
                                <button class="bw-button" onclick="startGame(3)"><span class="btn-icon">‚ñ∂</span> New</button>
                                <button class="bw-button" onclick="loadGame(3)" id="load-btn-3" disabled><span class="btn-icon">üìÇ</span> Load</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="add-client-screen" class="screen">
                <div class="bw-panel">
                    <h2 class="bw-header"><span class="header-icon">üë§</span> New Client Registration</h2>
                    <label for="client-name-input" class="bw-label">Client Name:</label>
                    <input type="text" id="client-name-input" class="bw-input" placeholder="Enter client's full name">
                    <p class="text-xs text-gray-500 mb-4">Opens a checking account and issues a debit card.</p>
                    <div class="flex justify-end gap-2">
                        <button class="bw-button" onclick="switchToBankView()"><span class="btn-icon">‚Ü©</span> Cancel</button>
                        <button class="bw-button" onclick="createClient()"><span class="btn-icon">‚úî</span> Register Client</button>
                    </div>
                </div>
            </div>

            <div id="client-view-screen" class="screen">
                 <div class="bw-panel">
                     <h2 class="bw-header"><span class="header-icon">üí≥</span> Client: <span id="client-view-name"></span></h2>
                     <div class="grid grid-cols-2 gap-4 mb-4">
                         <div>
                             <h3 class="text-sm font-semibold mb-1 uppercase">Checking Account</h3>
                             <p>Balance: $<span id="client-view-balance">0.00</span></p>
                         </div>
                         <div>
                             <h3 class="text-sm font-semibold mb-1 uppercase">Debit Card</h3>
                             <p class="text-xs">Number: <span id="client-view-card-number"></span></p>
                             <p class="text-xs">Expires: <span id="client-view-card-expiry"></span></p>
                             <p class="text-xs">CVV: <span id="client-view-card-cvv"></span></p>
                         </div>
                     </div>
                     <div class="grid grid-cols-2 gap-4">
                         <div>
                             <label for="deposit-amount" class="bw-label">Deposit:</label>
                             <input type="number" id="deposit-amount" class="bw-input" placeholder="Amount" min="0" step="0.01">
                             <button class="bw-button w-full" onclick="performDeposit()"><span class="btn-icon">‚ûï</span> Deposit</button>
                         </div>
                         <div>
                             <label for="withdraw-amount" class="bw-label">Withdraw:</label>
                             <input type="number" id="withdraw-amount" class="bw-input" placeholder="Amount" min="0" step="0.01">
                             <p class="text-xs text-gray-500 mb-1">Limit: $<span id="client-view-withdraw-limit"></span> / Day</p>
                             <button class="bw-button w-full" onclick="performWithdraw()"><span class="btn-icon">‚ûñ</span> Withdraw</button>
                         </div>
                     </div>
                     <p id="client-error-message" class="text-red-600 text-xs mt-2 text-center"></p>

                     <div class="transaction-log">
                         <h4><span class="header-icon">üìú</span> Transaction History</h4>
                         <div id="client-log-area" class="log-area">
                             <p class="text-xs text-gray-500">No transactions yet.</p>
                         </div>
                     </div>
                 </div>
                 <button class="bw-button mt-2 self-center" onclick="switchToBankView()"><span class="btn-icon">üè¶</span> Back to Bank View</button>
            </div>

            <div id="bank-view-screen" class="screen">
                <div class="bw-panel">
                    <h2 class="bw-header"><span class="header-icon">üí¥</span> ALKI corp.</h2>
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm">
                            <p>Liquid Cash: $<span id="bank-liquid-cash">0.00</span></p>
                            <p>Invested: $<span id="bank-invested-amount">0.00</span></p>
                            <p class="font-semibold">Total Assets: $<span id="bank-total-assets">0.00</span></p>
                        </div>
                         <button class="bw-button" onclick="switchToAddClientView()"><span class="btn-icon">üë§</span> Add New Client</button>
                    </div>

                    <h3 class="text-sm font-semibold mb-2 border-t pt-2 uppercase flex items-center gap-2"><span class="header-icon">üë•</span> Clients</h3>
                    <div id="client-list" class="mb-4 max-h-32 overflow-y-auto border p-2 rounded bg-gray-100">
                        <p class="text-xs text-gray-500">No clients yet.</p>
                    </div>

                     <h3 class="text-sm font-semibold mb-2 border-t pt-2 uppercase flex items-center gap-2"><span class="header-icon">üìà</span> Analytics</h3>
                     <div class="grid grid-cols-2 gap-4">
                         <div>
                             <div class="chart-container">
                                 <canvas id="clientMoneyChart"></canvas>
                             </div>
                             <p class="chart-title">Client Deposits</p>
                         </div>
                         <div>
                              <div class="chart-container">
                                  <canvas id="activityChart"></canvas>
                              </div>
                              <p class="chart-title">Activity Over Time</p>
                         </div>
                     </div>

                    <h3 class="text-sm font-semibold mb-2 border-t pt-2 uppercase flex items-center gap-2"><span class="header-icon">üí∞</span> Investments</h3>
                    <div class="text-center">
                        <button class="bw-button" onclick="switchToInvestmentView()"><span class="btn-icon">‚öôÔ∏è</span> Manage Investments</button>
                    </div>
                </div>
            </div>

            <div id="investment-view-screen" class="screen">
                 <div class="bw-panel">
                    <h2 class="bw-header"><span class="header-icon">üíº</span> Investment Portfolio</h2>
                    <p class="text-sm mb-2 text-center">Bank Liquid Cash: $<span id="invest-view-liquid-cash">0.00</span></p>

                    <div class="border p-3 rounded bg-gray-100 mb-4">
                        <h3 class="font-semibold text-center mb-2">S&P 500 Index Fund</h3>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs mb-3">
                            <span>Value: $<span id="sp500-current-value">0.00</span></span>
                            <span>Holdings: $<span id="sp500-holdings">0.00</span></span>
                            <span>Growth (Ann.): 10%</span>
                            <span>Dividend (Ann.): 3%</span>
                            <span>Next Dividend: <span id="sp500-next-dividend">---</span></span>
                            <span>Next Growth: <span id="sp500-next-growth">---</span></span>
                        </div>

                        <div class="flex gap-2 mt-3 items-end">
                            <div class="flex-grow">
                                <label for="invest-amount" class="bw-label">Invest:</label>
                                <input type="number" id="invest-amount" class="bw-input" placeholder="Amount" min="0" step="0.01">
                            </div>
                            <button class="bw-button" onclick="investSP500()"><span class="btn-icon">üìà</span> Invest</button>
                        </div>
                         <div class="flex gap-2 mt-1 items-end">
                            <div class="flex-grow">
                                 <label for="divest-amount" class="bw-label">Divest:</label>
                                <input type="number" id="divest-amount" class="bw-input" placeholder="Amount" min="0" step="0.01">
                            </div>
                            <button class="bw-button" onclick="divestSP500()"><span class="btn-icon">üìâ</span> Divest</button>
                        </div>
                        <p id="investment-error-message" class="text-red-600 text-xs mt-2 text-center"></p>
                    </div>

                    <button class="bw-button mt-2 self-center" onclick="switchToBankView()"><span class="btn-icon">üè¶</span> Back to Bank View</button>
                 </div>
            </div>

            </div>
    </div>

    <script>
        // --- Constants ---
        const DAILY_WITHDRAWAL_LIMIT = 500;
        const SP500_INITIAL_PRICE = 4500; // Placeholder starting price for the index
        const SP500_ANNUAL_GROWTH = 0.10; // 10%
        const SP500_ANNUAL_DIVIDEND = 0.03; // 3%
        const DAYS_PER_YEAR = 12; // 1 real day = 1 game month, so 12 real days = 1 game year
        const SAVE_KEY_PREFIX = 'bankingSimSave_';
        const GAME_LOOP_INTERVAL_MS = 5000; // Update game time every 5 seconds
        const REAL_MS_PER_GAME_DAY = 1000 * 60; // 1 minute real time = 1 game day

        // --- Game State ---
        let gameState = null; // Will hold the current game's state
        let currentSaveSlot = null;
        let gameLoopInterval = null;
        let clientMoneyChart = null;
        let activityChart = null;

        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const gameHud = document.getElementById('game-hud');
        const hudMode = document.getElementById('hud-mode');
        const hudDate = document.getElementById('hud-date');
        const saveIndicator = document.getElementById('save-indicator');
        const quitButton = document.getElementById('quit-button');

        // Client Add Screen
        const clientNameInput = document.getElementById('client-name-input');

        // Client View Screen
        const clientViewName = document.getElementById('client-view-name');
        const clientViewBalance = document.getElementById('client-view-balance');
        const clientViewCardNumber = document.getElementById('client-view-card-number');
        const clientViewCardExpiry = document.getElementById('client-view-card-expiry');
        const clientViewCardCvv = document.getElementById('client-view-card-cvv');
        const depositAmountInput = document.getElementById('deposit-amount');
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const clientViewWithdrawLimit = document.getElementById('client-view-withdraw-limit');
        const clientErrorMessage = document.getElementById('client-error-message');
        const clientLogArea = document.getElementById('client-log-area'); // Added log area

        // Bank View Screen
        const bankTotalAssets = document.getElementById('bank-total-assets');
        const bankLiquidCash = document.getElementById('bank-liquid-cash');
        const bankInvestedAmount = document.getElementById('bank-invested-amount');
        const clientListDiv = document.getElementById('client-list');
        const clientMoneyChartCtx = document.getElementById('clientMoneyChart').getContext('2d');
        const activityChartCtx = document.getElementById('activityChart').getContext('2d');


        // Investment View Screen
        const investViewLiquidCash = document.getElementById('invest-view-liquid-cash');
        const sp500CurrentValue = document.getElementById('sp500-current-value');
        const sp500Holdings = document.getElementById('sp500-holdings');
        const sp500NextDividend = document.getElementById('sp500-next-dividend');
        const sp500NextGrowth = document.getElementById('sp500-next-growth');
        const investAmountInput = document.getElementById('invest-amount');
        const divestAmountInput = document.getElementById('divest-amount');
        const investmentErrorMessage = document.getElementById('investment-error-message');


        // --- Utility Functions ---

        // Format currency
        function formatCurrency(amount) {
            // Use Intl for better formatting potentially, but toFixed is simpler here
            return amount.toFixed(2);
        }

        // Generate random debit card details
        function generateDebitCard() {
            const cardNumber = Array.from({ length: 16 }, () => Math.floor(Math.random() * 10)).join('');
            const expiryMonth = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
            const expiryYear = String(new Date().getFullYear() + Math.floor(Math.random() * 5) + 3).slice(-2); // Expires in 3-7 years
            const cvv = String(Math.floor(Math.random() * 900) + 100);
            return {
                number: cardNumber.replace(/(\d{4})/g, '$1 ').trim(), // Add spaces
                expiry: `${expiryMonth}/${expiryYear}`,
                cvv: cvv
            };
        }

        // Show a specific screen
        function showScreen(screenId) {
            console.log(`Switching to screen: ${screenId}`);
            let foundScreen = false;
            screens.forEach(screen => {
                if (screen.id === screenId) {
                    screen.classList.add('active');
                    foundScreen = true;
                } else {
                    screen.classList.remove('active');
                }
            });
            if (!foundScreen) {
                console.error(`Screen with id ${screenId} not found!`);
                document.getElementById('home-screen').classList.add('active'); // Fallback to home
            }
            // Hide HUD on home screen, show otherwise
            gameHud.style.display = (screenId === 'home-screen') ? 'none' : 'flex';
        }

        // Display a temporary error message
        function showTemporaryError(element, message) {
            element.textContent = message;
            setTimeout(() => {
                if (element.textContent === message) { // Only clear if message hasn't changed
                    element.textContent = '';
                }
            }, 3000); // Clear after 3 seconds
        }

        // Show save indicator briefly
        function flashSaveIndicator() {
            saveIndicator.classList.add('visible');
            setTimeout(() => {
                saveIndicator.classList.remove('visible');
            }, 1000); // Show for 1 second
        }

        // Get current game date string
        function getGameDateString(gameTime) {
            if (!gameTime || typeof gameTime.day !== 'number') {
                return 'Date Error'; // Handle cases where gameTime might be invalid
            }
            const totalMonths = Math.floor(gameTime.day); // Use floor for display
            const year = Math.floor(totalMonths / DAYS_PER_YEAR) + 1; // Start at Year 1
            const month = (totalMonths % DAYS_PER_YEAR) + 1; // Month 1-12
            return `Y${year} M${month}`; // Shorter format
        }

         // Get date string for next event
        function getNextEventDateString(currentDay, daysUntilEvent) {
            const targetDay = currentDay + daysUntilEvent;
            return getGameDateString({ day: targetDay });
        }

        // --- Game Logic Functions ---

        // Initialize a new game state
        function initializeNewGame() {
            return {
                clients: [], // Array of client objects
                bank: {
                    liquidCash: 100000, // Starting cash for the bank
                    investments: {
                        sp500: {
                            amountInvested: 0,
                            // Store the *day* the event should next occur
                            nextDividendDay: DAYS_PER_YEAR -1, // End of first year (day 11)
                            nextGrowthDay: DAYS_PER_YEAR -1   // End of first year (day 11)
                        }
                    },
                    transactionLog: [] // Log of bank's own transactions (investments, dividends)
                },
                gameTime: {
                    day: 0, // Represents game days passed (each day is a game month)
                    lastUpdateTimestamp: Date.now()
                },
                currentView: 'bank', // 'bank' or 'client'
                selectedClientId: null, // ID of the client being viewed
                sp500Price: SP500_INITIAL_PRICE // Store the 'current' price (remains fixed for now)
            };
        }

        // Save game state to localStorage
        function saveGame() {
            if (!gameState || currentSaveSlot === null) {
                 console.warn("Attempted to save with no active game state or slot.");
                 return;
            }
            try {
                // Before saving, capture current input values if needed (though generally avoided now)
                const saveData = JSON.stringify(gameState);
                localStorage.setItem(SAVE_KEY_PREFIX + currentSaveSlot, saveData);
                console.log(`Game saved to slot ${currentSaveSlot}`);
                updateHomeScreen(); // Update slot info on home screen (only if visible?)
                flashSaveIndicator();
            } catch (error) {
                console.error("Error saving game:", error);
                alert(`Error saving game: ${error.message}. Storage might be full.`);
            }
        }

        // Load game state from localStorage
        function loadGame(slot) {
            console.log(`Attempting to load game from slot ${slot}`);
            const saveData = localStorage.getItem(SAVE_KEY_PREFIX + slot);
            if (saveData) {
                try {
                    gameState = JSON.parse(saveData);
                    // Basic validation of loaded state
                    if (!gameState.gameTime || !gameState.bank || !gameState.clients) {
                        throw new Error("Invalid save data structure.");
                    }
                    // Ensure essential nested objects exist
                    gameState.bank.investments = gameState.bank.investments || {};
                    gameState.bank.investments.sp500 = gameState.bank.investments.sp500 || { amountInvested: 0, nextDividendDay: DAYS_PER_YEAR -1, nextGrowthDay: DAYS_PER_YEAR -1 };
                    gameState.clients.forEach(c => {
                        c.transactionHistory = c.transactionHistory || [];
                        c.dailyWithdrawn = c.dailyWithdrawn || 0;
                    });


                    currentSaveSlot = slot;
                    console.log("Game loaded successfully:", gameState);
                    startGameClock(); // Start the game clock after loading
                    updateUI(); // Update the entire UI based on loaded state
                    switchToBankView(); // Start in bank view after loading
                } catch (error) {
                    console.error(`Error loading game from slot ${slot}:`, error);
                    alert(`Failed to load save data from slot ${slot}. The data might be corrupted or from an incompatible version. Clearing slot.`);
                    localStorage.removeItem(SAVE_KEY_PREFIX + slot); // Clear corrupted data
                    gameState = null;
                    currentSaveSlot = null;
                    showScreen('home-screen');
                    updateHomeScreen();
                }
            } else {
                console.log(`No save data found for slot ${slot}`);
                 alert(`No save data found for slot ${slot}.`);
            }
        }

        // Start a new game
        function startGame(slot) {
            console.log(`Starting new game in slot ${slot}`);
            const existingData = localStorage.getItem(SAVE_KEY_PREFIX + slot);
            if (existingData) {
                if (!confirm(`Slot ${slot} contains saved data. Start a new game and overwrite it?`)) {
                    return; // User cancelled
                }
            }

            gameState = initializeNewGame();
            currentSaveSlot = slot;
            saveGame(); // Initial save
            startGameClock();
            updateUI();
            switchToBankView(); // Start in bank view
        }

        // Quit game and return to home screen
        function quitGame() {
            if (confirm("Quit to Main Menu? Progress is saved automatically.")) {
                stopGameClock();
                saveGame(); // Attempt a final save before quitting
                gameState = null;
                currentSaveSlot = null;
                // Clear potentially sensitive input fields on quit
                investAmountInput.value = '';
                divestAmountInput.value = '';
                depositAmountInput.value = '';
                withdrawAmountInput.value = '';
                clientNameInput.value = '';
                showScreen('home-screen');
                updateHomeScreen(); // Refresh home screen state
            }
        }

        // Update the home screen slot information
        function updateHomeScreen() {
            console.log("Updating home screen");
            for (let i = 1; i <= 3; i++) {
                const infoSpan = document.getElementById(`slot-${i}-info`);
                const loadButton = document.getElementById(`load-btn-${i}`);
                const saveData = localStorage.getItem(SAVE_KEY_PREFIX + i);
                if (saveData) {
                    try {
                        const data = JSON.parse(saveData);
                        // Validate basic structure
                        if (!data.gameTime || !data.clients) throw new Error("Minimal data missing");
                        const dateStr = getGameDateString(data.gameTime);
                        infoSpan.textContent = `Slot ${i}: ${dateStr}, ${data.clients.length} clients`;
                        loadButton.disabled = false;
                    } catch (e) {
                        infoSpan.textContent = `Slot ${i}: Data Error`;
                        loadButton.disabled = true;
                         // Consider not automatically removing here, maybe offer a "clear slot" button
                         // localStorage.removeItem(SAVE_KEY_PREFIX + i);
                         console.warn(`Slot ${i} data seems corrupted. Disabling load.`);
                    }
                } else {
                    infoSpan.textContent = `Slot ${i}: Empty`;
                    loadButton.disabled = true;
                }
            }
        }

        // --- Game Clock and Time Simulation ---
        function startGameClock() {
            stopGameClock(); // Ensure no duplicate intervals
            console.log("Starting game clock.");
            // Update time immediately on load/start to process any missed time
            updateGameTime();
            // Set interval
            gameLoopInterval = setInterval(updateGameTime, GAME_LOOP_INTERVAL_MS);
        }

        function stopGameClock() {
            if (gameLoopInterval) {
                clearInterval(gameLoopInterval);
                gameLoopInterval = null;
                console.log("Game clock stopped.");
            }
        }

        function updateGameTime() {
            if (!gameState) return;

            const now = Date.now();
            const elapsedMillis = now - (gameState.gameTime.lastUpdateTimestamp || now); // Use now if timestamp is missing
            // Calculate elapsed 'game days' based on real time passed
            const elapsedGameDays = elapsedMillis / REAL_MS_PER_GAME_DAY;

            const previousDayFloored = Math.floor(gameState.gameTime.day);
            gameState.gameTime.day += elapsedGameDays;
            gameState.gameTime.lastUpdateTimestamp = now;
            const currentDayFloored = Math.floor(gameState.gameTime.day);

            let needsSave = false;

            // Check if a full day (game month) or more has passed
            if (currentDayFloored > previousDayFloored) {
                const daysPassed = currentDayFloored - previousDayFloored;
                console.log(`Game day changed. ${daysPassed} day(s) passed. Current Day: ${currentDayFloored}`);

                for (let day = previousDayFloored + 1; day <= currentDayFloored; day++) {
                    // --- Yearly Events Check ---
                    // Check if end of year (day 11, 23, 35 etc.) is reached
                    if ((day + 1) % DAYS_PER_YEAR === 0) {
                         console.log(`End of Year reached (Day ${day}). Processing yearly events.`);
                         processSP500Growth(day);
                         processSP500Dividends(day);
                         needsSave = true;
                    }

                    // Reset daily limits for clients at the start of each new day
                    gameState.clients.forEach(client => {
                        client.dailyWithdrawn = 0;
                    });
                    needsSave = true; // Save needed as daily limits reset
                }

                // Update UI elements that depend on daily/yearly changes
                 if (document.getElementById('investment-view-screen').classList.contains('active')) {
                    updateInvestmentView(); // Update next event dates etc.
                 }
                 if (document.getElementById('client-view-screen').classList.contains('active')) {
                     updateClientView(); // Update daily limit display potentially
                 }
            }

            // Update HUD date display on every tick
            hudDate.textContent = getGameDateString(gameState.gameTime);

            // Autosave if significant events occurred
            if (needsSave) {
                saveGame();
            }
        }


        // --- Client Management ---

        function createClient() {
            const name = clientNameInput.value.trim();
            if (!name) {
                alert("Please enter the client's name.");
                return;
            }
            if (name.length > 30) { // Add a reasonable length limit
                 alert("Client name is too long (max 30 characters).");
                 return;
            }

            const newClient = {
                id: 'client_' + Date.now() + Math.random().toString(16).slice(2), // Unique ID
                name: name,
                checkingBalance: 0,
                debitCard: generateDebitCard(),
                dailyWithdrawn: 0, // Track daily withdrawal amount
                transactionHistory: [] // { type: 'deposit'/'withdrawal', amount: X, date: gameDay }
            };

            gameState.clients.push(newClient);
            clientNameInput.value = ''; // Clear input
            console.log("New client created:", newClient);
            saveGame();
            updateBankView(); // Refresh bank view list & charts
            switchToBankView(); // Go back to bank view after adding
        }

        function findClientById(clientId) {
            if (!gameState || !gameState.clients) return null;
            return gameState.clients.find(c => c.id === clientId);
        }

        function performDeposit() {
            const amount = parseFloat(depositAmountInput.value);
            const client = findClientById(gameState.selectedClientId);

            if (!client) {
                 console.error("Deposit failed: No client selected.");
                 showTemporaryError(clientErrorMessage, "Error: Client not found.");
                 return;
            }

            if (isNaN(amount) || amount <= 0 || amount > 1000000) { // Add upper limit
                showTemporaryError(clientErrorMessage, "Invalid deposit amount (must be > 0 and <= 1,000,000).");
                return;
            }

            client.checkingBalance += amount;
            client.transactionHistory.push({
                type: 'deposit',
                amount: amount,
                date: Math.floor(gameState.gameTime.day)
            });
            depositAmountInput.value = '';
            clientErrorMessage.textContent = '';
            console.log(`Deposited ${formatCurrency(amount)} for ${client.name}`);
            saveGame();
            updateClientView(); // Update balance display and log
            updateBankCharts(); // Update charts data
        }

        function performWithdraw() {
             const amount = parseFloat(withdrawAmountInput.value);
             const client = findClientById(gameState.selectedClientId);

             if (!client) {
                 console.error("Withdrawal failed: No client selected.");
                 showTemporaryError(clientErrorMessage, "Error: Client not found.");
                 return;
             }

             if (isNaN(amount) || amount <= 0) {
                 showTemporaryError(clientErrorMessage, "Invalid withdrawal amount.");
                 return;
             }
             if (amount > client.checkingBalance) {
                 showTemporaryError(clientErrorMessage, "Insufficient funds.");
                 return;
             }
             const remainingDailyLimit = DAILY_WITHDRAWAL_LIMIT - client.dailyWithdrawn;
             if (amount > remainingDailyLimit) {
                  showTemporaryError(clientErrorMessage, `Exceeds daily limit. You can withdraw $${formatCurrency(remainingDailyLimit)} more today.`);
                 return;
             }

             client.checkingBalance -= amount;
             client.dailyWithdrawn += amount;
             client.transactionHistory.push({
                 type: 'withdrawal',
                 amount: amount,
                 date: Math.floor(gameState.gameTime.day)
             });
             withdrawAmountInput.value = '';
             clientErrorMessage.textContent = '';
             console.log(`Withdrew ${formatCurrency(amount)} for ${client.name}`);
             saveGame();
             updateClientView(); // Update balance display and log
             updateBankCharts(); // Update charts data
        }

        // --- View Switching ---

        function switchToAddClientView() {
            showScreen('add-client-screen');
            hudMode.textContent = 'Bank > Add Client'; // Use > for hierarchy
            clientNameInput.focus(); // Focus input field
        }

        function switchToClientView(clientId) {
            const client = findClientById(clientId);
            if (client) {
                gameState.selectedClientId = clientId;
                gameState.currentView = 'client';
                updateClientView(); // Populate the view with client data
                showScreen('client-view-screen');
                hudMode.textContent = `Client > ${client.name}`;
            } else {
                console.error(`Client with ID ${clientId} not found!`);
            }
        }

        function switchToBankView() {
            gameState.selectedClientId = null;
            gameState.currentView = 'bank';
            updateBankView(); // Refresh bank view data
            showScreen('bank-view-screen');
            hudMode.textContent = 'Bank Dashboard';
        }

        function switchToInvestmentView() {
            updateInvestmentView(); // Populate investment data
            showScreen('investment-view-screen');
            hudMode.textContent = 'Bank > Investments';
        }

        // --- UI Update Functions ---

        // Update the entire UI based on gameState
        function updateUI() {
            if (!gameState) {
                showScreen('home-screen');
                updateHomeScreen();
                return;
            }

            // Update HUD Date (Mode is updated by specific view switch functions)
            hudDate.textContent = getGameDateString(gameState.gameTime);

            // Update the currently active view's content
            // This reduces redundant calls if the view hasn't changed
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) {
                 console.warn("No active screen found during updateUI, defaulting to bank view.");
                 switchToBankView();
                 return; // switchToBankView calls updateBankView
            }

            switch (activeScreen.id) {
                case 'bank-view-screen':
                    updateBankView();
                    break;
                case 'client-view-screen':
                    // Only update if a client is actually selected
                    if (gameState.selectedClientId) {
                        updateClientView();
                    } else {
                        console.warn("In client view screen but no client selected, switching to bank view.");
                        switchToBankView();
                    }
                    break;
                case 'investment-view-screen':
                    updateInvestmentView();
                    break;
                 case 'add-client-screen':
                     // No dynamic data needed here usually
                     break;
                 case 'home-screen':
                     // This case should ideally not happen if gameState exists
                     updateHomeScreen();
                     break;
            }
        }

        // Update the Client View Screen
        function updateClientView() {
            const client = findClientById(gameState.selectedClientId);
            if (!client) {
                console.error("Cannot update client view: client not found or not selected.");
                switchToBankView(); // Go back to safety
                return;
            }

            clientViewName.textContent = client.name;
            clientViewBalance.textContent = formatCurrency(client.checkingBalance);
            clientViewCardNumber.textContent = client.debitCard.number;
            clientViewCardExpiry.textContent = client.debitCard.expiry;
            clientViewCardCvv.textContent = client.debitCard.cvv;
            clientViewWithdrawLimit.textContent = formatCurrency(DAILY_WITHDRAWAL_LIMIT);

            // Update Transaction Log
            clientLogArea.innerHTML = ''; // Clear previous logs
            if (client.transactionHistory.length === 0) {
                 clientLogArea.innerHTML = '<p class="text-xs text-gray-500">No transactions yet.</p>';
            } else {
                // Show newest first
                [...client.transactionHistory].reverse().forEach(tx => {
                    const logElement = document.createElement('div');
                    logElement.className = 'log-entry';
                    const dateStr = getGameDateString({ day: tx.date });
                    const typeClass = tx.type === 'deposit' ? 'log-type-deposit' : 'log-type-withdrawal';
                    const typeSymbol = tx.type === 'deposit' ? '‚ûï' : '‚ûñ';
                    logElement.innerHTML = `
                        <span class="text-gray-500">${dateStr}:</span>
                        <span class="${typeClass}">${typeSymbol} ${tx.type.charAt(0).toUpperCase() + tx.type.slice(1)}</span>
                        <span>$${formatCurrency(tx.amount)}</span>
                    `;
                    clientLogArea.appendChild(logElement);
                });
            }

            // DO NOT CLEAR inputs here - only after successful action
            // depositAmountInput.value = '';
            // withdrawAmountInput.value = '';
            // clientErrorMessage.textContent = ''; // Keep error message until next action attempt
        }

        // Update the Bank View Screen
        function updateBankView() {
            if (!gameState) return;

            // Update Bank Stats (Corrected Logic)
            const investedAmount = gameState.bank.investments.sp500.amountInvested; // Add other investments later
            const bankTotalOwnAssets = gameState.bank.liquidCash + investedAmount;

            bankTotalAssets.textContent = formatCurrency(bankTotalOwnAssets);
            bankLiquidCash.textContent = formatCurrency(gameState.bank.liquidCash);
            bankInvestedAmount.textContent = formatCurrency(investedAmount);

            // Update Client List
            clientListDiv.innerHTML = ''; // Clear previous list
            if (gameState.clients.length === 0) {
                clientListDiv.innerHTML = '<p class="text-xs text-gray-500">No clients yet.</p>';
            } else {
                 // Sort clients alphabetically for consistency
                const sortedClients = [...gameState.clients].sort((a, b) => a.name.localeCompare(b.name));

                sortedClients.forEach(client => {
                    const clientElement = document.createElement('div');
                    // Added more padding, hover effect consistent with buttons
                    clientElement.className = 'flex justify-between items-center text-xs p-2 hover:bg-gray-200 cursor-pointer rounded border border-transparent hover:border-gray-500';
                    clientElement.innerHTML = `
                        <span>${client.name}</span>
                        <span>Bal: $${formatCurrency(client.checkingBalance)}</span>
                    `;
                    clientElement.onclick = () => switchToClientView(client.id);
                    clientListDiv.appendChild(clientElement);
                });
            }

            // Update Charts (ensure they are initialized)
             if (!clientMoneyChart || !activityChart) {
                 initializeCharts();
             }
            updateBankCharts();
        }

        // Update the Investment View Screen
        function updateInvestmentView() {
             if (!gameState) return;

             investViewLiquidCash.textContent = formatCurrency(gameState.bank.liquidCash);
             sp500CurrentValue.textContent = formatCurrency(gameState.sp500Price); // This remains fixed for now
             sp500Holdings.textContent = formatCurrency(gameState.bank.investments.sp500.amountInvested);

             // Calculate next event dates based on stored next event day
             const currentDay = Math.floor(gameState.gameTime.day);
             sp500NextDividend.textContent = getGameDateString({ day: gameState.bank.investments.sp500.nextDividendDay });
             sp500NextGrowth.textContent = getGameDateString({ day: gameState.bank.investments.sp500.nextGrowthDay });


             // DO NOT clear inputs here - preserve user input during time updates
             // investAmountInput.value = '';
             // divestAmountInput.value = '';
             // investmentErrorMessage.textContent = ''; // Keep error message until next action attempt
        }


        // --- Charting Functions ---

        function initializeCharts() {
            console.log("Initializing charts...");
            // Destroy existing charts if they exist
            if (clientMoneyChart) {
                console.log("Destroying existing client money chart.");
                clientMoneyChart.destroy();
            }
            if (activityChart) {
                 console.log("Destroying existing activity chart.");
                 activityChart.destroy();
            }


            // Chart Defaults from root styles
            Chart.defaults.font.family = getComputedStyle(document.documentElement).getPropertyValue('--font-primary').trim();
            Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--color-text-medium').trim();
            Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--color-panel-border').trim();


             // Client Money Distribution (Doughnut Chart)
             const clientMoneyColors = [ // Define a color palette
                '#4fc3f7', '#ff7043', '#66bb6a', '#ffee58', '#ab47bc', '#ef5350', '#26a69a'
             ];
            clientMoneyChart = new Chart(clientMoneyChartCtx, {
                type: 'doughnut',
                data: {
                    labels: [], // Client names
                    datasets: [{
                        label: 'Client Deposits',
                        data: [], // Client balances
                        backgroundColor: clientMoneyColors,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-panel-bg').trim(), // Match panel bg
                        borderWidth: 3,
                        hoverOffset: 8 // Make segment pop out more on hover
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 500 // Shorter animation
                    },
                    plugins: {
                        legend: {
                            display: false // Keep legend hidden
                        },
                        tooltip: { // Customize tooltips
                             enabled: true, // Ensure enabled
                             backgroundColor: 'rgba(0, 0, 0, 0.8)',
                             titleFont: { size: 10, family: Chart.defaults.font.family },
                             bodyFont: { size: 9, family: Chart.defaults.font.family },
                             padding: 8,
                             cornerRadius: 3,
                             boxPadding: 4, // Padding inside the tooltip box
                             callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += '$' + formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        },
                        title: {
                             display: false
                        }
                    }
                }
            });

            // Activity Chart (Line Chart)
            activityChart = new Chart(activityChartCtx, {
                type: 'line',
                data: {
                    labels: [], // Game days/months/years
                    datasets: [
                        {
                            label: 'Deposits',
                            data: [], // Cumulative deposits per time period
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-accent-green').trim(),
                            backgroundColor: 'rgba(76, 175, 80, 0.1)', // Use root color with alpha
                            tension: 0.2, // Smoother curve
                            fill: true,
                            pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--color-accent-green').trim(),
                            pointRadius: 2,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'Withdrawals',
                            data: [], // Cumulative withdrawals per time period
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-accent-red').trim(),
                            backgroundColor: 'rgba(244, 67, 54, 0.1)', // Use root color with alpha
                            tension: 0.2,
                            fill: true,
                             pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--color-accent-red').trim(),
                             pointRadius: 2,
                             pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                     animation: {
                        duration: 500 // Shorter animation
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: { size: 8 },
                                callback: function(value) { // Format Y axis ticks as currency
                                    return '$' + value.toLocaleString(); // Basic formatting
                                }
                            },
                            grid: {
                                color: 'rgba(170, 170, 170, 0.2)' // Lighter grid lines
                            }
                        },
                        x: {
                             ticks: {
                                font: { size: 8 },
                                maxRotation: 0, // Prevent label rotation
                                autoSkip: true, // Allow chart.js to skip labels if too crowded
                                maxTicksLimit: 8 // Limit number of X-axis ticks shown
                            },
                             grid: {
                                color: 'rgba(170, 170, 170, 0.2)'
                            }
                        }
                    },
                    plugins: {
                         legend: {
                             position: 'bottom', // Move legend below
                             labels: {
                                font: { size: 9 },
                                boxWidth: 15, // Smaller color box
                                padding: 10 // Padding around legend items
                            }
                        },
                         tooltip: { // Customize tooltips
                             enabled: true,
                             backgroundColor: 'rgba(0, 0, 0, 0.8)',
                             titleFont: { size: 10, family: Chart.defaults.font.family },
                             bodyFont: { size: 9, family: Chart.defaults.font.family },
                             padding: 8,
                             cornerRadius: 3,
                             boxPadding: 4,
                             mode: 'index', // Show tooltips for both datasets at the same x-index
                             intersect: false, // Show tooltip even if not directly hovering over point
                             callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                         title: {
                             display: false
                        }
                    }
                }
            });
             console.log("Charts initialized.");
        }

        function updateBankCharts() {
            if (!gameState || !clientMoneyChart || !activityChart) {
                 console.warn("Skipping chart update: Charts not ready or no game state.");
                 return;
            }
             console.log("Updating bank charts...");

            // --- Update Client Money Distribution Chart ---
            const clientNames = gameState.clients.map(c => c.name.substring(0, 15)); // Truncate long names for labels
            const clientBalances = gameState.clients.map(c => c.checkingBalance);

            // Only update if data actually changed to avoid needless redraws
            if (JSON.stringify(clientMoneyChart.data.labels) !== JSON.stringify(clientNames) ||
                JSON.stringify(clientMoneyChart.data.datasets[0].data) !== JSON.stringify(clientBalances))
            {
                clientMoneyChart.data.labels = clientNames;
                clientMoneyChart.data.datasets[0].data = clientBalances;
                clientMoneyChart.update();
                console.log("Client money chart updated.");
            } else {
                 console.log("Client money chart data unchanged.");
            }


            // --- Update Activity Chart ---
            const activityData = {}; // { gameDay: { deposits: X, withdrawals: Y } }
            gameState.clients.forEach(client => {
                client.transactionHistory.forEach(tx => {
                    const day = tx.date;
                    if (!activityData[day]) {
                        activityData[day] = { deposits: 0, withdrawals: 0 };
                    }
                    if (tx.type === 'deposit') {
                        activityData[day].deposits += tx.amount;
                    } else if (tx.type === 'withdrawal') {
                        activityData[day].withdrawals += tx.amount;
                    }
                });
            });

            const labels = [];
            const depositPoints = [];
            const withdrawalPoints = [];
            let cumulativeDeposits = 0;
            let cumulativeWithdrawals = 0;
            const maxDay = Math.floor(gameState.gameTime.day);

            // Generate points for each day up to the current day
            for (let day = 0; day <= maxDay; day++) {
                 if (activityData[day]) {
                    cumulativeDeposits += activityData[day].deposits;
                    cumulativeWithdrawals += activityData[day].withdrawals;
                }
                // Add label and data point for each day (Chart.js will handle skipping labels if needed via options)
                labels.push(getGameDateString({ day: day })); // Use game date string for label
                depositPoints.push(cumulativeDeposits);
                withdrawalPoints.push(cumulativeWithdrawals);
            }

             // Only update if data actually changed
             if (JSON.stringify(activityChart.data.labels) !== JSON.stringify(labels) ||
                 JSON.stringify(activityChart.data.datasets[0].data) !== JSON.stringify(depositPoints) ||
                 JSON.stringify(activityChart.data.datasets[1].data) !== JSON.stringify(withdrawalPoints))
             {
                activityChart.data.labels = labels;
                activityChart.data.datasets[0].data = depositPoints;
                activityChart.data.datasets[1].data = withdrawalPoints;
                activityChart.update();
                console.log("Activity chart updated.");
             } else {
                 console.log("Activity chart data unchanged.");
             }
        }


        // --- Investment Logic ---

        function investSP500() {
            const amount = parseFloat(investAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showTemporaryError(investmentErrorMessage, "Invalid investment amount.");
                return;
            }
            if (amount > gameState.bank.liquidCash) {
                 showTemporaryError(investmentErrorMessage, "Insufficient liquid cash.");
                 return;
            }

            gameState.bank.liquidCash -= amount;
            gameState.bank.investments.sp500.amountInvested += amount;
            gameState.bank.transactionLog.push({ type: 'invest', asset: 'S&P 500', amount: amount, date: Math.floor(gameState.gameTime.day) });

            console.log(`Invested ${formatCurrency(amount)} in S&P 500`);
            investAmountInput.value = ''; // Clear input on success
            investmentErrorMessage.textContent = '';
            saveGame();
            updateInvestmentView(); // Update investment display
            updateBankView(); // Update bank totals display
        }

        function divestSP500() {
             const amount = parseFloat(divestAmountInput.value);
             const currentInvestment = gameState.bank.investments.sp500.amountInvested;

             if (isNaN(amount) || amount <= 0) {
                 showTemporaryError(investmentErrorMessage, "Invalid divestment amount.");
                 return;
             }
             if (amount > currentInvestment) {
                  showTemporaryError(investmentErrorMessage, "Cannot divest more than invested.");
                  return;
             }

             gameState.bank.investments.sp500.amountInvested -= amount;
             gameState.bank.liquidCash += amount;
             gameState.bank.transactionLog.push({ type: 'divest', asset: 'S&P 500', amount: amount, date: Math.floor(gameState.gameTime.day) });

             console.log(`Divested ${formatCurrency(amount)} from S&P 500`);
             divestAmountInput.value = ''; // Clear input on success
             investmentErrorMessage.textContent = '';
             saveGame();
             updateInvestmentView();
             updateBankView();
        }

        function processSP500Growth(currentDay) {
            const investment = gameState.bank.investments.sp500;
            if (investment.amountInvested > 0) {
                 const growthAmount = investment.amountInvested * SP500_ANNUAL_GROWTH;
                 investment.amountInvested += growthAmount;
                 // Set next growth day
                 investment.nextGrowthDay = currentDay + DAYS_PER_YEAR;
                 console.log(`S&P 500 grew by ${formatCurrency(growthAmount)}. New value: ${formatCurrency(investment.amountInvested)}`);
                 // Log this? Maybe a separate event log later.
            } else {
                 // If no investment, still advance the next growth day marker
                 investment.nextGrowthDay = currentDay + DAYS_PER_YEAR;
            }
        }

        function processSP500Dividends(currentDay) {
            const investment = gameState.bank.investments.sp500;
             if (investment.amountInvested > 0) {
                // Calculate dividend based on value *before* growth in the same year for simplicity
                // (Alternatively, calculate after growth, depends on desired simulation detail)
                const dividendAmount = investment.amountInvested * SP500_ANNUAL_DIVIDEND; // Using current value
                gameState.bank.liquidCash += dividendAmount;
                gameState.bank.transactionLog.push({ type: 'dividend', asset: 'S&P 500', amount: dividendAmount, date: currentDay });
                // Set next dividend day
                investment.nextDividendDay = currentDay + DAYS_PER_YEAR;
                console.log(`Received S&P 500 dividend of ${formatCurrency(dividendAmount)}.`);
             } else {
                  // If no investment, still advance the next dividend day marker
                 investment.nextDividendDay = currentDay + DAYS_PER_YEAR;
             }
        }


        // --- Initialization ---
        function initializeApp() {
            console.log("Initializing Banking Sim v2...");
            updateHomeScreen(); // Check for existing save files and update buttons
            initializeCharts(); // Set up chart instances *after* styles are loaded
            showScreen('home-screen'); // Start at the home screen

            // Add event listener for the quit button
            quitButton.addEventListener('click', quitGame);

            console.log("App Initialized.");
        }

        // --- Run Initialization on Load ---
        // Use DOMContentLoaded for faster script execution start,
        // but ensure styles affecting Chart.js defaults are applied.
        // window.onload might be safer if CSS loading timing is critical for charts.
        document.addEventListener('DOMContentLoaded', initializeApp);
        // window.onload = initializeApp; // Alternative if DOMContentLoaded causes issues

    </script>
</body>
</html>