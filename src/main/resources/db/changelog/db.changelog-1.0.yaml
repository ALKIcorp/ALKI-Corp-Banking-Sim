databaseChangeLog:
  - changeSet:
      id: 1-create-bank-state
      author: alkicorp
      validCheckSum: 9:68ef7037a5e1c1ea0c95ce8a671e7989
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        not:
          - tableExists:
              tableName: bank_state
      changes:
        - createTable:
            tableName: bank_state
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: slot_id
                  type: INT
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: liquid_cash
                  type: DECIMAL(19,2)
                  constraints:
                    nullable: false
              - column:
                  name: invested_sp500
                  type: DECIMAL(19,2)
                  constraints:
                    nullable: false
              - column:
                  name: sp500_price
                  type: DECIMAL(19,2)
                  constraints:
                    nullable: false
              - column:
                  name: game_day
                  type: DOUBLE
                  constraints:
                    nullable: false
              - column:
                  name: next_dividend_day
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: next_growth_day
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: last_update_timestamp
                  type: TIMESTAMP
                  constraints:
                    nullable: false
  - changeSet:
      id: 2-create-client
      author: alkicorp
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        not:
          - tableExists:
              tableName: client
      changes:
        - createTable:
            tableName: client
            columns:
              - column:
                  name: id
                  type: BIGINT AUTO_INCREMENT
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: bank_state_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: slot_id
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: name
                  type: VARCHAR(80)
                  constraints:
                    nullable: false
              - column:
                  name: checking_balance
                  type: DECIMAL(19,2)
                  constraints:
                    nullable: false
              - column:
                  name: daily_withdrawn
                  type: DECIMAL(19,2)
                  constraints:
                    nullable: false
              - column:
                  name: card_number
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: card_expiry
                  type: VARCHAR(8)
                  constraints:
                    nullable: false
              - column:
                  name: card_cvv
                  type: VARCHAR(4)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: client
            baseColumnNames: bank_state_id
            constraintName: fk_client_bank_state
            referencedTableName: bank_state
            referencedColumnNames: id
        - createIndex:
            tableName: client
            indexName: idx_client_slot
            columns:
              - column:
                  name: slot_id
  - changeSet:
      id: 3-create-transaction
      author: alkicorp
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        not:
          - tableExists:
              tableName: client_transaction
      changes:
        - createTable:
            tableName: client_transaction
            columns:
              - column:
                  name: id
                  type: BIGINT AUTO_INCREMENT
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: client_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: type
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
              - column:
                  name: amount
                  type: DECIMAL(19,2)
                  constraints:
                    nullable: false
              - column:
                  name: game_day
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: client_transaction
            baseColumnNames: client_id
            constraintName: fk_tx_client
            referencedTableName: client
            referencedColumnNames: id
        - createIndex:
            tableName: client_transaction
            indexName: idx_tx_client
            columns:
              - column:
                  name: client_id
  - changeSet:
      id: 4-create-investment-event
      author: alkicorp
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        not:
          - tableExists:
              tableName: investment_event
      changes:
        - createTable:
            tableName: investment_event
            columns:
              - column:
                  name: id
                  type: BIGINT AUTO_INCREMENT
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: slot_id
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: type
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
              - column:
                  name: asset
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
              - column:
                  name: amount
                  type: DECIMAL(19,2)
                  constraints:
                    nullable: false
              - column:
                  name: game_day
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false
        - createIndex:
            tableName: investment_event
            indexName: idx_investment_slot
            columns:
              - column:
                  name: slot_id
  - changeSet:
      id: 5-seed-bank-state
      author: alkicorp
      changes:
        - insert:
            tableName: bank_state
            columns:
              - column:
                  name: slot_id
                  valueNumeric: 1
              - column:
                  name: liquid_cash
                  valueNumeric: 100000
              - column:
                  name: invested_sp500
                  valueNumeric: 0
              - column:
                  name: sp500_price
                  valueNumeric: 4500
              - column:
                  name: game_day
                  valueNumeric: 0
              - column:
                  name: next_dividend_day
                  valueNumeric: 11
              - column:
                  name: next_growth_day
                  valueNumeric: 11
              - column:
                  name: last_update_timestamp
                  valueComputed: CURRENT_TIMESTAMP
        - insert:
            tableName: bank_state
            columns:
              - column:
                  name: slot_id
                  valueNumeric: 2
              - column:
                  name: liquid_cash
                  valueNumeric: 100000
              - column:
                  name: invested_sp500
                  valueNumeric: 0
              - column:
                  name: sp500_price
                  valueNumeric: 4500
              - column:
                  name: game_day
                  valueNumeric: 0
              - column:
                  name: next_dividend_day
                  valueNumeric: 11
              - column:
                  name: next_growth_day
                  valueNumeric: 11
              - column:
                  name: last_update_timestamp
                  valueComputed: CURRENT_TIMESTAMP
        - insert:
            tableName: bank_state
            columns:
              - column:
                  name: slot_id
                  valueNumeric: 3
              - column:
                  name: liquid_cash
                  valueNumeric: 100000
              - column:
                  name: invested_sp500
                  valueNumeric: 0
              - column:
                  name: sp500_price
                  valueNumeric: 4500
              - column:
                  name: game_day
                  valueNumeric: 0
              - column:
                  name: next_dividend_day
                  valueNumeric: 11
              - column:
                  name: next_growth_day
                  valueNumeric: 11
              - column:
                  name: last_update_timestamp
                  valueComputed: CURRENT_TIMESTAMP
  - changeSet:
      id: 6-fix-bank-state-id-auto-increment
      author: alkicorp
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        and:
          - tableExists:
              tableName: bank_state
          - columnExists:
              tableName: bank_state
              columnName: id
      changes:
        - addAutoIncrement:
            tableName: bank_state
            columnName: id
            columnDataType: BIGINT
        - sql:
            sql: ALTER TABLE bank_state ALTER COLUMN id RESTART WITH 4
            dbms: h2
  - changeSet:
      id: 7-fix-client-id-auto-increment
      author: alkicorp
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        and:
          - tableExists:
              tableName: client
          - columnExists:
              tableName: client
              columnName: id
      changes:
        - addAutoIncrement:
            tableName: client
            columnName: id
            columnDataType: BIGINT
  - changeSet:
      id: 8-fix-client-transaction-id-auto-increment
      author: alkicorp
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        and:
          - tableExists:
              tableName: client_transaction
          - columnExists:
              tableName: client_transaction
              columnName: id
      changes:
        - addAutoIncrement:
            tableName: client_transaction
            columnName: id
            columnDataType: BIGINT
  - changeSet:
      id: 9-fix-investment-event-id-auto-increment
      author: alkicorp
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        and:
          - tableExists:
              tableName: investment_event
          - columnExists:
              tableName: investment_event
              columnName: id
          - sqlCheck:
              expectedResult: 0
              sql: >
                SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS
                WHERE TABLE_NAME = 'INVESTMENT_EVENT'
                  AND COLUMN_NAME = 'ID'
                  AND IS_IDENTITY = 'YES'
      changes:
        - addAutoIncrement:
            tableName: investment_event
            columnName: id
            columnDataType: BIGINT
  - changeSet:
      id: 10-seed-slot-1-data-v2
      author: alkicorp
      runAlways: true
      changes:
        # Update bank_state for slot 1 with seed data
        - sql:
            sql: >
              UPDATE bank_state
              SET liquid_cash = 250000.00,
                  invested_sp500 = 50000.00,
                  sp500_price = 4750.00,
                  game_day = 12.0,
                  next_dividend_day = 21,
                  next_growth_day = 18,
                  last_update_timestamp = PARSEDATETIME('2024-01-13 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              WHERE slot_id = 1
        # Delete existing data for slot 1 (if any)
        - sql:
            sql: >
              DELETE FROM client_transaction 
              WHERE client_id IN (SELECT id FROM client WHERE slot_id = 1)
        - sql:
            sql: >
              DELETE FROM client WHERE slot_id = 1
        # Insert clients for slot 1
        - sql:
            sql: >
              INSERT INTO client (bank_state_id, slot_id, name, checking_balance, daily_withdrawn, card_number, card_expiry, card_cvv, created_at)
              SELECT 
                (SELECT id FROM bank_state WHERE slot_id = 1),
                1,
                'Starboy The Ponderer',
                12800.00,
                200.00,
                '4532 2047 1100 9001',
                '10/27',
                '247',
                PARSEDATETIME('2024-01-01 00:00:00', 'yyyy-MM-dd HH:mm:ss')
        - sql:
            sql: >
              INSERT INTO client (bank_state_id, slot_id, name, checking_balance, daily_withdrawn, card_number, card_expiry, card_cvv, created_at)
              SELECT 
                (SELECT id FROM bank_state WHERE slot_id = 1),
                1,
                'Maison Alkibiades',
                34250.00,
                0.00,
                '5555 2047 2200 9002',
                '03/28',
                '318',
                PARSEDATETIME('2024-01-02 00:00:00', 'yyyy-MM-dd HH:mm:ss')
        - sql:
            sql: >
              INSERT INTO client (bank_state_id, slot_id, name, checking_balance, daily_withdrawn, card_number, card_expiry, card_cvv, created_at)
              SELECT 
                (SELECT id FROM bank_state WHERE slot_id = 1),
                1,
                'Mason Bramadat',
                5150.00,
                50.00,
                '4532 2047 3300 9003',
                '07/26',
                '909',
                PARSEDATETIME('2024-01-03 00:00:00', 'yyyy-MM-dd HH:mm:ss')
        - sql:
            sql: >
              INSERT INTO client (bank_state_id, slot_id, name, checking_balance, daily_withdrawn, card_number, card_expiry, card_cvv, created_at)
              SELECT 
                (SELECT id FROM bank_state WHERE slot_id = 1),
                1,
                'Hal Gibert',
                60200.00,
                0.00,
                '5555 2047 4400 9004',
                '12/29',
                '612',
                PARSEDATETIME('2024-01-04 00:00:00', 'yyyy-MM-dd HH:mm:ss')
        - sql:
            sql: >
              INSERT INTO client (bank_state_id, slot_id, name, checking_balance, daily_withdrawn, card_number, card_expiry, card_cvv, created_at)
              SELECT 
                (SELECT id FROM bank_state WHERE slot_id = 1),
                1,
                'Rosemont Runner',
                2750.00,
                120.00,
                '4532 2047 5500 9005',
                '01/28',
                '505',
                PARSEDATETIME('2024-01-05 00:00:00', 'yyyy-MM-dd HH:mm:ss')
        # Insert transactions for Starboy The Ponderer
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'DEPOSIT', 15000.00, 0, PARSEDATETIME('2024-01-01 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Starboy The Ponderer'
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'WITHDRAWAL', 2000.00, 7, PARSEDATETIME('2024-01-08 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Starboy The Ponderer'
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'WITHDRAWAL', 200.00, 12, PARSEDATETIME('2024-01-13 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Starboy The Ponderer'
        # Insert transactions for Maison Alkibiades
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'DEPOSIT', 50000.00, 1, PARSEDATETIME('2024-01-02 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Maison Alkibiades'
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'WITHDRAWAL', 7500.00, 5, PARSEDATETIME('2024-01-06 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Maison Alkibiades'
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'WITHDRAWAL', 8250.00, 9, PARSEDATETIME('2024-01-10 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Maison Alkibiades'
        # Insert transactions for Mason Bramadat
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'DEPOSIT', 6200.00, 2, PARSEDATETIME('2024-01-03 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Mason Bramadat'
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'WITHDRAWAL', 1000.00, 6, PARSEDATETIME('2024-01-07 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Mason Bramadat'
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'WITHDRAWAL', 50.00, 12, PARSEDATETIME('2024-01-13 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Mason Bramadat'
        # Insert transactions for Hal Gibert
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'DEPOSIT', 75000.00, 3, PARSEDATETIME('2024-01-04 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Hal Gibert'
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'WITHDRAWAL', 14800.00, 8, PARSEDATETIME('2024-01-09 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Hal Gibert'
        # Insert transactions for Rosemont Runner
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'DEPOSIT', 3200.00, 4, PARSEDATETIME('2024-01-05 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Rosemont Runner'
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'WITHDRAWAL', 330.00, 10, PARSEDATETIME('2024-01-11 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Rosemont Runner'
        - sql:
            sql: >
              INSERT INTO client_transaction (client_id, type, amount, game_day, created_at)
              SELECT id, 'WITHDRAWAL', 120.00, 12, PARSEDATETIME('2024-01-13 00:00:00', 'yyyy-MM-dd HH:mm:ss')
              FROM client WHERE slot_id = 1 AND name = 'Rosemont Runner'
